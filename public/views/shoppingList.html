<?php include 'public/views/groupHeader.html'; ?>

<link href="/public/styles/shoppingList.css" type="text/css" rel="stylesheet"/>

<div class="tab-panel active" style="padding-bottom: 6rem;"> <div class="shopping-list-tabs-container no-scrollbar">
    <?php if (!empty($lists)): ?>
    <?php foreach ($lists as $index => $list): ?>
    <button
            onclick="loadList(<?= $list['id'] ?>, this)"
            class="list-tab-button <?= ($index === 0) ? 'list-tab-active' : 'list-tab-inactive' ?>">
        <?= htmlspecialchars($list['name']) ?>
    </button>
    <?php endforeach; ?>
    <?php endif; ?>

    <button onclick="openNewListModal()"
            class="list-tab-button new-list-btn">
        + Nowa lista
    </button>
</div>

    <div id="items-container">
        <section class="mt-4">
            <div class="section-header-wrapper">
                <h2 class="section-title">Do kupienia</h2>
                <span id="to-buy-count" class="items-count-badge">
                    0 produktÃ³w
                </span>
            </div>
            <div id="active-items-list" class="items-list-container">
                <p class="empty-state-text">Wybierz listÄ™, aby zobaczyÄ‡ produkty.</p>
            </div>
        </section>

        <section class="purchased-section">
            <h2 class="purchased-header">
                Kupione
            </h2>
            <div id="purchased-items-list" class="items-list-container">
            </div>
        </section>
    </div>

</div>

<div class="shopping-bottom-actions">
    <div class="add-item-wrapper">
        <input type="text" id="new-item-name" placeholder="Co trzeba kupiÄ‡?"
               class="add-item-input"
               onkeypress="handleEnter(event)">
        <button onclick="addItem()" class="add-item-btn">
            <span class="material-symbols-outlined">add</span>
        </button>
    </div>
</div>

</main> </div> <script>
    const groupId = <?= $groupId ?>;
    let currentListId = <?= $activeListId ?? 'null' ?>;

    document.addEventListener('DOMContentLoaded', () => {
        const initialItems = <?= json_encode($items ?? []) ?>;
        if (currentListId && initialItems.length > 0) {
            renderItems(initialItems);
        } else if (currentListId) {
            renderItems([]);
        }
    });

    function loadList(listId, btnElement) {
        currentListId = listId;

        document.querySelectorAll('.list-tab-active').forEach(el => {
            el.classList.remove('list-tab-active');
            el.classList.add('list-tab-inactive');
        });
        btnElement.classList.remove('list-tab-inactive');
        btnElement.classList.add('list-tab-active');

        fetch(`/groups/${groupId}/lists/${listId}/items`)
            .then(res => res.json())
            .then(items => {
                renderItems(items);
            })
            .catch(err => console.error(err));
    }

    function renderItems(items) {
        const activeContainer = document.getElementById('active-items-list');
        const purchasedContainer = document.getElementById('purchased-items-list');
        const countBadge = document.getElementById('to-buy-count');

        activeContainer.innerHTML = '';
        purchasedContainer.innerHTML = '';

        let activeCount = 0;

        items.forEach(item => {
            const isPurchased = item.is_purchased;
            if (!isPurchased) activeCount++;

            const html = `
                <div class="shopping-item-row group">
                    <label class="shopping-item-label">
                        <input type="checkbox"
                               class="shopping-item-checkbox"
                               ${isPurchased ? 'checked' : ''}
                               onchange="toggleItem(${item.id},${isPurchased})">
                        <div class="${isPurchased ? 'purchased-text' : ''}">
                            <p class="item-name">${escapeHtml(item.name)}</p>
                            ${item.subtitle ? `<p class="item-subtitle">${escapeHtml(item.subtitle)}</p>` : ''}
                        </div>
                    </label>
                    <button onclick="deleteItem(${item.id}, this)" class="delete-btn">
                        <span class="material-symbols-outlined" style="font-size: 1.25rem;">delete</span>
                    </button>
                </div>
            `;

            if (isPurchased) {
                purchasedContainer.innerHTML += html;
            } else {
                activeContainer.innerHTML += html;
            }
        });

        countBadge.innerText = `${activeCount} produktÃ³w`;

        if (activeCount === 0 && activeContainer.innerHTML === '') {
            activeContainer.innerHTML = '<p class="empty-state-text">Wszystko kupione! ðŸŽ‰</p>';
        }
    }

    function addItem() {
        if (!currentListId) {
            alert('Wybierz lub stwÃ³rz najpierw listÄ™!');
            return;
        }

        const input = document.getElementById('new-item-name');
        const name = input.value.trim();
        if (!name) return;

        fetch(`/groups/${groupId}/lists/${currentListId}/items/add`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    input.value = '';
                    loadList(currentListId, document.querySelector('.list-tab-active'));
                }
            });
    }

    function handleEnter(e) {
        if (e.key === 'Enter') addItem();
    }

    function toggleItem(itemId,currentStatus) {



        fetch(`/groups/${groupId}/items/${itemId}/toggle`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                toggleStatus:currentStatus

            })

        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    loadList(currentListId, document.querySelector('.list-tab-active'));
                }
            });
    }

    function deleteItem(itemId, btn) {
        if(!confirm('UsunÄ…Ä‡ ten produkt?')) return;

        fetch(`/groups/${groupId}/items/${itemId}/delete`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const row = btn.closest('.shopping-item-row');
                    row.remove();
                }
            });
    }

    function openNewListModal() {
        const name = prompt("Podaj nazwÄ™ nowej listy:");
        if (name) {
            fetch(`/groups/${groupId}/lists/add`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    }
                });
        }
    }

    function escapeHtml(text) {
        if (!text) return '';
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
</script>

</body>
</html>