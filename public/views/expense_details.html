<!doctype html>
<html lang="<?= TranslationService::getInstance()->getCurrentLang() ?>">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title><?= $expenseDetails->name ?? trans('expenses.no_name') ?></title>

    <script>
        (function() {
            const theme = localStorage.getItem('userTheme') || 'light';
            document.documentElement.classList.add('theme-' + theme);
        })();
    </script>

    <link href="/public/styles/_theme.css" type="text/css" rel="stylesheet"/>
    <link href="/public/styles/_base.css" type="text/css" rel="stylesheet"/>
    <link href="/public/styles/_components.css" type="text/css" rel="stylesheet"/>
    <link href="/public/styles/groups.css" type="text/css" rel="stylesheet"/>
    <link href="/public/styles/expense.css" type="text/css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap"
          rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
          rel="stylesheet"/>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24 }
    </style>
    <script src="/public/scripts/theme.js"></script>
</head>

<body class="whole-page-group-details">

<?php
    $date = new DateTime($expenseDetails->dateIncurred ?? 'now');
$formattedDate = $date->format('l, d F Y');
?>

<div class="page-wrapper group-details-page-wrapper">
    <script src="/public/scripts/expandMenu.js" defer></script>
    <header class="app-bar">
        <div style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: flex-start;">
            <a href="/groups/<?= $groupId ?>/expenses" style="color: inherit; text-decoration: none; display: flex;">
                <span class="material-symbols-outlined">arrow_back</span>
            </a>
        </div>
        <h1></h1> <div class="dropdown-menu-wrapper">
        <button type="button" id="dropdown-toggle" aria-expanded="false" aria-controls="context-menu">
            <span class="material-symbols-outlined">more_vert</span>
        </button>

        <div id="context-menu" class="dropdown-menu">
            <a href="/groups/<?= $groupId ?>/expense/<?= $expenseDetails->id ?>/edit" class="dropdown-item">
                <span class="material-symbols-outlined">edit</span> <?= trans('common.edit') ?>
            </a>
            <a href="/groups/<?= $groupId ?>/expense/<?= $expenseDetails->id ?>/delete" class="dropdown-item delete-action">
                <span class="material-symbols-outlined">delete</span> <?= trans('common.delete') ?>
            </a>
        </div>
    </div>
    </header>

    <main class="page-groups" style="padding-top: 5rem;">

        <div class="expense-header-section">

            <div class="item-icon-wrapper expense-icon-large"
                 style="background-color: <?= $expenseDetails->iconBgColor ?? 'var(--color-primary-bg)'; ?>;">
                <span class="material-symbols-outlined" style="color: <?= $expenseDetails->iconColor ?? 'var(--color-primary)'; ?>;">
                    <?= $expenseDetails->icon ?? 'attach_money' ?>
                </span>
            </div>

            <h1 class="expense-amount">
                <?= $expenseDetails->name ?? trans('expenses.no_name') ?>
            </h1>

            <p class="expense-name">
                <?= number_format($expenseDetails->amount ?? 0, 2, ',', ' ') ?> zł
            </p>

            <p class="list-item-secondary-text">
                <?= $formattedDate ?>
            </p>
        </div>

        <div class="expense-detail-card">

            <div class="expense-detail-row">
                <p class="detail-label"><?= trans('expenses.paid_by_label') ?></p>
                <p class="detail-value"><?= $expenseDetails->payerName ?? '?' ?></p>
            </div>

            <div class="expense-detail-row">
                <p class="detail-label"><?= trans('expenses.category') ?></p>
                <p class="detail-value"><?= $expenseDetails->categoryName ?? trans('expenses.no_category') ?></p>
            </div>
        </div>

        <div class="expense-detail-card">
            <p class="detail-value" style="margin-bottom: 0.5rem;">
                <?= trans('expenses.split_between') ?>
            </p>

            <?php if (!empty($expenseDetails->splits)): ?>
            <?php foreach ($expenseDetails->splits as $split):
                $avatarUrl = isset($split->profilePicture) && !empty($split->profilePicture)
                    ? htmlspecialchars($split->profilePicture)
                    : 'https://ui-avatars.com/api/?name=' . urlencode($split->userFullName) . '&size=44&background=4CAF50&color=fff&bold=true';
            ?>
            <div class="expense-detail-row split-row" style="border-top: none;">
                <div class="split-details-left">
                    <img class="user-avatar"
                         alt="<?= $split->userFullName ?? '?' ?> avatar"
                         src="<?= $avatarUrl ?>"/>
                    <p style="font-weight: 500; color: var(--color-text-body);"><?= $split->userFullName ?></p>
                </div>
                <p class="split-amount-negative">
                    - <?= number_format($split->amountOwed ?? 0, 2, ',', ' ') ?> zł
                </p>
            </div>
            <?php endforeach; ?>
            <?php else: ?>
            <p class="list-item-secondary-text"><?= trans('expenses.not_split') ?></p>
            <?php endif; ?>
        </div>

        <div style="height: 3rem;"></div>

    </main>

</div>
<div id="delete-group-modal" class="modal-overlay">
    <div class="modal-content">
        <h3><?= trans('expenses.confirm_delete_title') ?></h3>
        <p><?= trans('expenses.confirm_delete_message') ?></p>

        <form id="delete-form" method="POST">
            <input type="hidden" name="_method" value="DELETE">

            <div class="modal-actions">
                <button type="button" class="action-button secondary" id="modal-cancel">
                    <?= trans('common.cancel') ?>
                </button>
                <button type="submit" class="action-button primary">
                    <?= trans('common.delete') ?>
                </button>
            </div>
        </form>
    </div>
</div>
</body>
</html>