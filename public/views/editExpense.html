<!doctype html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Edycja: <?= $expense->name ?? 'Wydatek' ?></title>

    <link href="/public/styles/_theme.css" type="text/css" rel="stylesheet"/>
    <link href="/public/styles/_base.css" type="text/css" rel="stylesheet"/>
    <link href="/public/styles/_components.css" type="text/css" rel="stylesheet"/>
    <link href="/public/styles/addExpense.css" type="text/css" rel="stylesheet"/>

    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap"
          rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
          rel="stylesheet"/>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
    </style>
</head>

<body class="theme-light whole-page-group-details">
<div class="page-wrapper">
    <header class="app-bar">
        <div style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: flex-start;">
            <a href="/groups/<?= $groupId ?>/expense/<?= $expense->id ?>" style="color: inherit; text-decoration: none; display: flex;">
                <span class="material-symbols-outlined">arrow_back</span>
            </a>
        </div>
        <h1>Edytuj Wydatek</h1>
        <div style="width: 48px; height: 48px;"></div>
    </header>

    <form action="/groups/<?= $groupId ?>/expense/<?= $expense->id ?>/edit" method="POST" style="display: contents;">
        <input type="hidden" name="_method" value="PATCH"/>
        <main class="page-form-container page-container">
            <div class="form-header-group">
                <h1 class="headline-text">Edytuj wydatek</h1>
            </div>

            <div class="input-field-wrapper">
                <label class="form-label" for="expense_name">Nazwa</label>
                <input
                        id="expense_name"
                        name="name"
                        type="text"
                        class="input-group-text"
                        placeholder="np. Zakupy spożywcze"
                        value="<?= $expense->name ?? '' ?>" required
                />
            </div>

            <div class="input-field-wrapper">
                <label class="form-label" for="amount">Kwota</label>
                <div class="input-suffix-wrapper">
                    <input
                            id="amount"
                            name="amount"
                            type="number"
                            step="0.01"
                            class="input-group-text"
                            placeholder="0.00"
                            value="<?= $expense->amount ?? '' ?>" required
                    />
                    <span class="input-suffix-text">PLN</span>
                </div>
            </div>

            <div class="grid-2-col">
                <div class="input-field-wrapper">
                    <label class="form-label" for="category">Kategoria</label>
                    <div class="input-suffix-wrapper">
                        <select class="input-group-text" name="category" id="category" required>
                            <option disabled="" value="">Wybierz</option>
                            <?php if(!empty($categories)):
            foreach ($categories as $category):
            $selected = ($category->id == $expense->categoryId) ? 'selected' : '';
?>
                            <option value="<?= $category->id ?>" <?= $selected ?>><?= $category->name ?></option>
                            <?php endforeach;
    endif;
    ?>
                        </select>
                        <span class="material-symbols-outlined input-suffix-text"
                              style="right: 0.5rem;">expand_more</span>
                    </div>
                </div>

                <div class="input-field-wrapper">
                    <label class="form-label" for="date">Data</label>
                    <input
                            id="date"
                            name="date"
                            type="date"
                            class="input-group-text"
                            value="<?= $expense->date ?? date('Y-m-d'); ?>" required
                    />
                </div>

            </div>
            <div class="input-field-wrapper">
                <label class="form-label" for="paidBy">Zapłacono przez:</label>
                <select id="paidBy" name="paidBy" class="input-group-text" required>
                    <?php
        if(!empty($users)):
            foreach ($users as $user):
            $selected = ($user->id == $expense->paidByUserId) ? 'selected' : '';
?>
                    <option <?= $selected ?>
                    value="<?= $user->id ?>"><?= $user->firstname ?> <?= $user->lastname ?></option>
                    <?php endforeach;
    endif;
    ?>
                </select>
            </div>
            <div>
                <p class="form-label" style="padding-bottom: 0.75rem;">Podziel pomiędzy</p>
                <div class="split-user-list">
                    <?php
        if(!empty($users)):
            foreach ($users as $user):
            $checked = in_array($user->id, $splitUserIds) ? 'checked' : '';
            $ratio = $expense->splitRatios[$user->id] ?? 1;
?>
                    <div class="user-split-item" data-user-id="<?= $user->id ?>">
                        <div class="split-user-details">
                            <img class="user-avatar" alt="Avatar of user 1"
                                 src="https://lh3.googleusercontent.com/aida-public/AB6AXuDIspL8uVDwe572-ePv26dWXcOQbcJMq_UwUF7_929Mu_LSA4hhrzykzZmlaz_AlocYt3hD-_lUx8BvjXP4SrNOPCBHEQlW5G_I8pJRSkvDyucTI22JiMp1Jt7CnzTth43iNB6tqzbHUd71XpqS04ak3UGUQT5CISRDd3MIiFHWSz6lmAnyL0jCz2_piOiY9E_oCJmjW8i_RU2jDzI5UEp2uxWAdfdZTrVqHxomDaAR9QgsLL-RAih7B3-zM26Vw39W_3Jn03aAvs-L"/>
                            <span style="font-weight: 600;"><?= $user->firstname ?> <?= $user->lastname ?></span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <input class="split-ratio-input" type="number" min="1" step="1" name="split_ratio_<?= $user->id ?>" value="<?= $ratio ?>" style="display: none; width: 4rem; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid var(--color-border-input); text-align: center; font-weight: 600;"/>
                            <input class="split-amount-input" type="number" min="0" step="0.01" name="split_amount_<?= $user->id ?>" value="<?= $expense->splitAmounts[$user->id] ?? '0' ?>" style="display: none; width: 5rem; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid var(--color-border-input); text-align: center; font-weight: 600;" placeholder="0.00"/>
                            <input <?= $checked ?> class="checkbox-style split-checkbox" type="checkbox" name="split_user_<?= $user->id ?>" value="1"/>
                        </div>
                    </div>
                    <?php endforeach;
    endif;
    ?>
                </div>
            </div>

            <div class="split-mode-toggle-wrapper">
                <input type="hidden" name="split_mode" id="split_mode" value="<?= $expense->splitMode ?>"/>
                <div class="split-mode-toggle" style="grid-template-columns: repeat(3, 1fr);">
                    <button type="button" class="<?= $expense->splitMode === 'equal' ? 'active-mode' : '' ?>" data-mode="equal">Równo</button>
                    <button type="button" class="<?= $expense->splitMode === 'ratio' ? 'active-mode' : '' ?>" data-mode="ratio">Na części</button>
                    <button type="button" class="<?= $expense->splitMode === 'amount' ? 'active-mode' : '' ?>" data-mode="amount">Kwoty</button>
                </div>
                <div id="amount-validation-message" style="display: none; margin-top: 0.5rem; padding: 0.75rem; background-color: #FEE2E2; color: #991B1B; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 500;">
                    Suma kwot nie zgadza się z całkowitą kwotą wydatku
                </div>
            </div>
        </main>

        <div class="bottom-actions">
            <div class="action-buttons-wrapper">
                <button type="submit" class="action-button primary">
                    Zapisz zmiany
                </button>
            </div>
        </div>
    </form>
</div>
<script src="/public/scripts/splitMode.js"></script>
</body>
</html>